### README: Система мониторинга сервера Linux с PostgreSQL

---

#### **Описание проекта**  
Этот проект представляет собой систему для автоматического сбора, хранения и анализа метрик производительности сервера Linux с использованием PostgreSQL. Он демонстрирует следующие навыки:  
- **Работа с SQL**: Создание таблиц, написание запросов для анализа данных, оптимизация производительности.  
- **Администрирование Linux**: Настройка cron, работа с системными утилитами (top, iostat, df), управление правами.  
- **Решение проблем**: Анализ метрик для выявления узких мест и генерация рекомендаций.  
- **Автоматизация**: Использование Bash-скриптов и cron для регулярного сбора данных.  

---

#### **Особенности**  
- **Автоматический сбор метрик**:  
  - Загрузка CPU, использование памяти, состояние дисков, сетевые интерфейсы.  
  - Логирование данных в PostgreSQL.  
- **Хранение данных**:  
  - Структурированное хранение в таблицах с временным штампом.  
- **Анализ данных**:  
  - SQL-запросы для агрегации (средние значения, пики нагрузки).  
  - Уведомления о критических метриках (например, 90% загрузки CPU).  
- **Отказоустойчивость**:  
  - Резервное копирование базы данных, возможность расширения до репликации PostgreSQL.  

---

#### **Требования**  
- **ОС**: Linux (тестировалось на Ubuntu 20.04+).  
- **Зависимости**:  
  - PostgreSQL (`sudo apt install postgresql`).  
  - `iostat` (`sysstat` пакет).  
  - `cron` для автоматического запуска.  

---

#### **Установка**  
1. **Установите PostgreSQL**:  
   ```bash
   sudo apt update && sudo apt install postgresql sysstat
   ```

2. **Создайте пользователя и базу данных**:  
   ```bash
   sudo -u postgres createuser -P monitoring_user
   sudo -u postgres createdb -O monitoring_user monitoring_db
   ```

3. **Настройте права доступа** (в файле `pg_hba.conf`):  
   ```bash
   sudo nano /etc/postgresql/12/main/pg_hba.conf
   # Добавьте строку:
   local   monitoring_db   monitoring_user   trust
   ```

4. **Создайте таблицы** в PostgreSQL:  
   ```bash
   psql -U monitoring_user -d monitoring_db -f schema.sql
   ```

5. **Настройте cron** (откройте редактор):  
   ```bash
   crontab -e
   # Добавьте строку для запуска каждые 5 минут:
   */5 * * * * /path/to/metrics_collector.sh
   ```

---

#### **Использование**  
1. **Запуск вручную**:  
   ```bash
   ./metrics_collector.sh
   ```

2. **Проверка данных в PostgreSQL**:  
   ```bash
   psql -U monitoring_user -d monitoring_db
   SELECT * FROM cpu_metrics ORDER BY timestamp DESC LIMIT 10;
   ```

3. **Пример SQL-запроса для анализа**:  
   ```sql
   -- Средняя загрузка CPU за последние 24 часа
   SELECT AVG(cpu_usage) AS avg_cpu_usage
   FROM cpu_metrics
   WHERE timestamp > NOW() - INTERVAL '24 HOURS';
   ```

4. **Уведомления**:  
   - Скрипт `alert_checker.sh` отправляет email при превышении порога загрузки CPU.  
   - Убедитесь, что установлен почтовый клиент (`mailutils`):  
     ```bash
     sudo apt install mailutils
     ```

---

#### **Примеры решения проблем**  
**Проблема**: Высокая нагрузка на диск.  
**Анализ**:  
```sql
-- Пиковые значения записи на диск за последний час
SELECT device, MAX(write_mb) AS max_write
FROM disk_metrics
WHERE timestamp > NOW() - INTERVAL '1 HOUR'
GROUP BY device;
```
**Рекомендации**:  
- Проверьте логи (`journalctl`) на наличие ошибок диска.  
- Оптимизируйте запросы к БД или перераспределите нагрузку.  

---

#### **Документация**  
- **schema.sql**: SQL-скрипт для создания таблиц.  
- **metrics_collector.sh**: Основной скрипт сбора метрик.  
- **alert_checker.sh**: Скрипт уведомлений.  
- **Пример отчета**: См. `reports/example_report.md`.  

---

#### **Расширение проекта**  
- Интеграция с **Grafana** для визуализации данных.  
- Настройка **репликации PostgreSQL** для отказоустойчивости.  
- Добавление метрик сети и логов в реальном времени.  

